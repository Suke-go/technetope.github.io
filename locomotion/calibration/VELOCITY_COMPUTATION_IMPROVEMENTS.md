# 速度計算の改善（時間重み付き移動平均）

## 概要

人間検出システムの速度計算を、信号処理の観点から改善しました。最新2フレームの単純平均から、時間重み付き移動平均（Exponentially Weighted Moving Average, EWMA）に変更し、静止時のノイズ対策と動きの予測精度を向上させました。

---

## 改善内容

### 1. 時間重み付き速度計算

**従来の方法:**
```cpp
// 最新2フレームの単純平均
velocity = (position[t] - position[t-1]) / delta_time
```

**改善後の方法:**
```cpp
// 指数減衰重みを使用した時間重み付き平均
weight_i = exp(-α * (t_current - t_i))
velocity = Σ(velocity_i * weight_i) / Σ(weight_i)
```

**特徴:**
- より最近のフレームにより大きな重みを付ける
- 過去60フレーム（約2秒@30fps）を使用
- 半減期（half-life）に基づく減衰係数を使用

### 2. ノイズ対策

#### 2.1 ノイズフィルタ
```cpp
// 小さな動きを無視（ノイズ閾値以下）
if (distance < noise_threshold_mm) {
  // ノイズとして処理をスキップ
}
```

#### 2.2 外れ値除去
```cpp
// 統計的な外れ値検出
z_score = |distance - mean| / std_dev
if (z_score > outlier_threshold_std) {
  // 外れ値として処理をスキップ
}
```

#### 2.3 位置の平滑化
```cpp
// 指数平滑化
smoothed_position = α * current_position + (1 - α) * previous_smoothed
```

### 3. 静止判定の改善

**従来の方法:**
```cpp
// 単純な速度閾値判定
if (velocity < threshold) {
  state = STANDING;
}
```

**改善後の方法:**
```cpp
// 時間重み付き速度 + 位置変動 + 連続性チェック
1. 時間重み付き速度を計算
2. 位置変動を時間重み付きで計算
3. 過去10フレームのうち8フレーム以上で静止しているか確認
```

---

## 実装詳細

### パラメータ

```cpp
// 時間重み付き速度計算
double velocity_half_life_seconds{0.5};  // 速度の半減期（秒）
double velocity_alpha{0.1};              // 指数減衰係数（使用しない、半減期から計算）

// 位置の平滑化
double position_smoothing_alpha{0.3};    // 位置の平滑化係数（0.0-1.0）

// ノイズ対策
double noise_threshold_mm{5.0};          // ノイズと見なす移動距離の閾値（mm）
double outlier_threshold_std{3.0};       // 外れ値判定の標準偏差倍率
bool enable_outlier_rejection{true};     // 外れ値除去を有効化

// 履歴
int movement_history_frames{60};         // 動き判定に使用するフレーム数（60フレーム ≈ 2秒@30fps）
```

### 計算フロー

```
1. 位置検出
   ↓
2. 外れ値チェック
   - 統計的外れ値検出（Z-score）
   ↓
3. 位置の平滑化
   - 指数平滑化
   ↓
4. 履歴に追加
   - 位置履歴（最大60フレーム）
   - 時刻履歴
   ↓
5. 時間重み付き速度計算
   - 指数減衰重みを計算
   - ノイズフィルタを適用
   - 重み付き平均を計算
   - 前回の速度と指数平滑化
   ↓
6. 動き状態判定
   - 時間重み付き速度をチェック
   - 位置変動を時間重み付きで計算
   - 連続性をチェック
```

---

## 数式

### 指数減衰重み

```
α = ln(2) / half_life_seconds
weight_i = exp(-α * (t_current - t_i))
```

### 時間重み付き速度

```
velocity = Σ(velocity_i * weight_i) / Σ(weight_i)
```

### 指数平滑化

```
smoothed_t = α * current_t + (1 - α) * smoothed_{t-1}
```

### 外れ値検出（Z-score）

```
mean = (1/n) * Σ(distance_i)
variance = (1/n) * Σ((distance_i - mean)²)
std_dev = √variance
z_score = |distance - mean| / std_dev
if (z_score > threshold) {
  // 外れ値
}
```

---

## 効果

### 1. ノイズ低減

- **静止時のノイズ**: 小さな動き（< 5mm）を無視
- **外れ値除去**: 統計的外れ値検出により、異常な値による影響を軽減
- **位置の平滑化**: 指数平滑化により、位置の変動を平滑化

### 2. 動きの予測精度向上

- **時間重み付き**: より最近のフレームにより大きな重みを付ける
- **長期的な履歴**: 過去60フレーム（約2秒）を使用
- **連続性**: 過去10フレームのうち8フレーム以上で静止しているか確認

### 3. 恒常性（静止時の安定性）

- **静止判定の改善**: 単純な速度閾値から、時間重み付き速度 + 位置変動 + 連続性チェックに変更
- **ノイズ耐性**: 小さなノイズによる誤判定を防止
- **外れ値耐性**: 異常な値による誤判定を防止

---

## 参考資料

### 指数移動平均（EMA）

- Wikipedia: [Exponential moving average](https://en.wikipedia.org/wiki/Exponential_moving_average)
- 半減期に基づく減衰: `α = ln(2) / half_life`

### 時系列フィルタリング

- ローパスフィルタ
- カルマンフィルタ（将来的な改善案）
- 移動平均フィルタ

### 外れ値検出

- Z-score法
- 標準偏差ベースの外れ値検出

---

## 今後の改善案

### 1. カルマンフィルタ

現在の指数平滑化から、より高度なカルマンフィルタに変更することで、動きの予測精度をさらに向上させることができます。

### 2. 適応的パラメータ調整

動き状態（静止/移動）に応じて、平滑化係数やノイズ閾値を動的に調整することで、より良い結果が得られる可能性があります。

### 3. 加速度の考慮

速度だけでなく、加速度も考慮することで、動きの予測精度を向上させることができます。

---

## まとめ

時間重み付き移動平均とノイズ対策により、静止時の恒常性と動きの予測精度が向上しました。特に、静止時のノイズ対策により、ユーザーが止まっている時の動作がより安定して検出されるようになりました。

