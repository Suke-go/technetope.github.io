# これからの実装計画

## フィールド定義
- 左上座標 `(34, 35)`, 右下座標 `(949, 898)` の長方形領域を想定する。
- 実寸換算では 1260 mm × 1188 mm のフィールドに対応させる。
- 周囲から 50 mm の安全マージンを取り、運動計画で利用する実効フィールドをその範囲内に限定する。
- MotionPlanner 内部はこのフィールド座標系（左上原点・右下最大）を基準に処理する。

## ロボット仕様
- サイズ 71 mm × 32 mm の小型ロボットがフィールド内を移動する。
- 32 mm の短辺方向を前後軸とし、前後移動を主体に運用する。
- 位置・姿勢の基準点はロボット中央とする。

## 最終目標
- ロボットはフィールド内をランダムに動き続け、可能であれば複数台が群れを形成し合流・分離を繰り返す振る舞いを実装する。
- すべてのロボット同士が衝突しないよう、距離維持や動的回避を含む安全制御を取り入れる。

## プログラム構成案
- **MotionPlanner**（既存サンプルを置き換える主役）: `initial_targets`/`next_targets` API は維持しつつ内部ロジックを刷新する。  
  - メンバーとして `RandomVelocityGenerator`（ランダム速度更新）と `CollisionGuard`（ポテンシャル反発・速度クリップ）を保持。  
  - `next_targets` は `[現在位置] → [ランダム速度更新] → [衝突回避補正] → [速度クリップ/積分]` の順でフィールド座標ターゲットを計算し、直近位置ではなく「少し先にいてほしい地点（短時間先の目標）」を返す。  
  - 追加クラスは `motion_planner.cpp` 内部 or ネストで実装し、サンプルアプリからの呼び出しシグネチャは変更しない。
- **RandomVelocityGenerator**: Ornstein–Uhlenbeck 過程で `v_rand` を更新する小クラス。境界接近時の折り返し処理やグループ中心へのバイアスを担当。
- **CollisionGuard**: 各ロボ間・境界との距離を評価し、反発ポテンシャル `f_rep` を計算して `v_rand` に加算または上書きする安全レイヤー。デッドロック緩和の優先度ロジックもここに含める。
- **RobotController**: MotionPlanner が出すフィールド座標ターゲットを基に、差動モデルの `v, ω` 指令へ変換。内部で PID/Pure Pursuit を持ち、実機送信を担当。
- **Utilities**: 座標変換（mm ⇔ フィールド）、安全マージン計算、ログ記録、パラメータロードをまとめたヘルパー群。

## アルゴリズム
 **ランダムベクトル生成 (Ornstein–Uhlenbeck)**  
- 各ロボットが内部状態として目標速度 `v_rand` を保持し、`v_{t+Δt} = v_t + θ (μ - v_t) Δt + σ √Δt ξ`（ξは正規乱数）で更新する。  
- `μ ≈ 0` なら純粋なランダム遊泳、`μ` をグループ中心方向へ置けば「まとまり」の演出ができる。  
- フィールド境界や安全マージンに近づいた際は `v_rand` を境界に沿って折り返すか減衰させ、外側へ飛び出さないようにする。

 **衝突回避 (ポテンシャル場 + 速度制限)**  
- 各ロボ間距離 `d` が安全閾値 `d_safe` を下回ると `f_rep = k_rep (1/d - 1/d_safe)` のような反発ベクトルを加算。  
- フィールド境界に対しても同様のポテンシャルを設定し、境界に近づくほど強い反発を与える。  
- 速度指令は最終的に `|v| ≤ v_max`, `|ω| ≤ ω_max` にクリップし、`brake_distance = v²/(2 a_max)` が残距離以下になるようチェック。  
- 必要なら近接ロボとの Deadlock 解消用に「優先度」または「パーソナルスペース」値を導入し、優先度が低い側が停止 or 進路変更する。
- 今後の実装はこのポテンシャル場ベースの衝突回避を主軸に進め、他機能（ランダム遊泳・群形成）はこの安全層の上に積み上げる。

## 座標変換ルール
- mm → フィールド座標:  
  - 横方向: `x_field = 34 + (x_mm / 1260) * (949 - 34)`  
  - 縦方向: `y_field = 35 + (y_mm / 1188) * (898 - 35)`
- フィールド座標 → mm:  
  - `x_mm = (x_field - 34) * 1260 / (949 - 34)`  
  - `y_mm = (y_field - 35) * 1188 / (898 - 35)`
- スケール係数は `scale_x ≈ 0.7262 px/mm`, `scale_y ≈ 0.7265 px/mm`。  
  例: ロボット寸法 71 mm × 32 mm はフィールド座標では約 `51.6 × 23.2` に相当する。
